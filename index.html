<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Business Monthly Report</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --paper:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --soft:#f1f5f9;

      --blue:#2563eb;
      --teal:#0ea5e9;
      --violet:#7c3aed;
      --amber:#f59e0b;

      --good:#16a34a;
      --bad:#dc2626;

      --shadow: 0 30px 60px -25px rgba(0,0,0,0.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Noto Sans JP',system-ui,sans-serif;
      background: radial-gradient(1200px 700px at 10% 10%, #18223d, var(--bg));
      color:var(--ink);
      padding:20px;
      display:flex;
      justify-content:center;
      overflow-x:auto;
    }

    .app{
      width:min(1320px, 100%);
      background:var(--paper);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,0.08);
      overflow-x:auto;
      overflow-y:visible;
    }

    /* Top bar */
    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      padding:16px 18px;
      background:linear-gradient(90deg, #0f172a, #101c38);
      color:#fff;
      border-bottom:1px solid rgba(255,255,255,0.08);
      flex-wrap:wrap;
    }

    /* Top nav */
    .nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .tab{
      color:#fff;
      text-decoration:none;
      font-weight:800;
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      white-space:nowrap;
    }
    .tab.active{ background:rgba(37,99,235,.92); border-color:rgba(37,99,235,1); }
    .title{
      display:flex;flex-direction:column;gap:4px;
      min-width: 260px;
    }
    .title h1{
      margin:0;
      font-family:'Montserrat',sans-serif;
      letter-spacing:1px;
      font-size:18px;
      font-weight:800;
      white-space:nowrap;
    }
    .title .sub{
      font-size:12px;
      opacity:.85;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .top-controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex:1 1 auto;
      min-width: 280px;
    }

    .chip{
      display:flex;align-items:center;gap:10px;
      background:rgba(255,255,255,0.08);
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      flex:0 0 auto;
    }
    .chip .p{
      font-family:'Montserrat',sans-serif;
      font-weight:800;
      color:#93c5fd;
      font-size:14px;
      white-space:nowrap;
    }
    .chip .status{
      font-size:12px;
      opacity:.9;
      white-space:nowrap;
    }

    .date-range{
      display:flex; gap:8px; align-items:center;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.14);
    }
    .date-range label{
      font-size:12px; opacity:.9; font-weight:700; white-space:nowrap;
    }
    .date-range input{
      border:none; outline:none;
      padding:6px 8px;
      border-radius:10px;
      background:rgba(255,255,255,0.12);
      color:#fff;
      font-weight:700;
      font-size:12px;
    }
    .date-range input::-webkit-calendar-picker-indicator{
      filter: invert(1);
      opacity:.9;
    }

    .actions{
      display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end;
    }
    .btn{
      appearance:none;border:none;cursor:pointer;
      padding:10px 12px;border-radius:10px;
      font-weight:800;font-size:12px;
      color:#fff;background:rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.16);
      transition:.15s transform, .15s background;
      white-space:nowrap;
    }
    .btn:hover{ background:rgba(255,255,255,0.16); transform:translateY(-1px); }
    .btn.primary{ background:rgba(37,99,235,0.92); border-color:rgba(37,99,235,1); }
    .btn.primary:hover{ background:rgba(37,99,235,1); }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: minmax(0, 1fr) clamp(360px, 34vw, 520px);
      gap:16px;
      padding:16px;
      background:linear-gradient(180deg, #ffffff, #f8fafc);
      min-width: 0;
    }
    .grid > *{ min-width:0; }

    @media (max-width: 1180px){
      .grid{ grid-template-columns: 1fr; }
      .top-controls{ justify-content:flex-start; }
    }

    .card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: 0 14px 30px -24px rgba(15,23,42,0.35);
      min-width:0;
    }

    .hrow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }

    .h2{
      margin:0;
      font-size:14px;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .dot{
      height:10px;width:10px;border-radius:4px;
      display:inline-block; flex:0 0 auto;
    }
    .dot.blue{ background:var(--blue); }
    .dot.teal{ background:var(--teal); }
    .dot.violet{ background:var(--violet); }
    .dot.amber{ background:var(--amber); }

    .subline{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      white-space:nowrap;
    }
    .subline strong{
      color:var(--ink);
      font-weight:900;
    }

    /* KPI cards */
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
      min-width:0;
    }
    @media (max-width: 700px){
      .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .kpi{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:linear-gradient(180deg, #ffffff, #f8fafc);
      min-width:0;
    }
    .kpi .label{
      font-size:11px; font-weight:900; color:var(--muted);
    }
    .kpi .val{
      display:flex; align-items:baseline; gap:6px;
      margin-top:6px;
    }
    .kpi .num{
      font-family:'Montserrat',sans-serif;
      font-weight:900;
      font-size:28px;
      color:var(--ink);
    }
    .kpi .unit{
      font-size:12px; font-weight:900; color:#94a3b8;
    }
    .delta{
      margin-top:8px;
      font-size:11px;
      font-weight:900;
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .delta .tag{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--soft);
      font-weight:900;
    }
    .delta.good{ color:var(--good); }
    .delta.bad{ color:var(--bad); }
    .delta.neutral{ color:var(--muted); }

    /* Highlight stats */
    .highlights{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:0;
    }
    @media (max-width: 700px){
      .highlights{ grid-template-columns:1fr; }
    }
    .highlight{
      border-radius:14px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, #ffffff, #f8fafc);
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .highlight .left{
      display:flex; flex-direction:column; gap:4px; min-width:0;
    }
    .highlight .t{
      font-size:11px; font-weight:900; color:var(--muted);
    }
    .big-input{
      width: 140px;
      border:none;
      outline:none;
      padding:0;
      background:transparent;
      font-family:'Montserrat',sans-serif;
      font-weight:900;
      font-size:26px;
      color:var(--ink);
      line-height:1;
      text-align:right;
    }
    .big-input:focus{
      border-radius:10px;
      background:var(--soft);
      padding:6px 10px;
      box-shadow: inset 0 0 0 2px rgba(37,99,235,.55);
    }
    .highlight .badge{
      font-size:11px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--soft);
      white-space:nowrap;
    }

    /* Metric inputs */
    .metric-wrap{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
      align-items:stretch;
      grid-auto-rows: 1fr;
    }
    @media (max-width: 820px){
      .metric-wrap{ grid-template-columns:1fr; }
    }
    .metric-box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
      min-width:0;
      display:flex;
      flex-direction:column;
    }
    .metric-head{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:8px;
      margin-bottom:10px;
      min-width:0;
    }
    .metric-title{
      font-size:13px;
      font-weight:900;
      margin:0;
      min-width:0;
    }
    .metric-period{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      white-space:nowrap;
    }
    .metric-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
      min-width:0;
      flex:1;
      align-content:start;
    }
    .metric{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:linear-gradient(180deg, #ffffff, #f8fafc);
      min-width:0;
    }
    .metric .mlabel{
      font-size:11px;
      font-weight:900;
      color:var(--muted);
      margin-bottom:6px;
    }
    .metric .mrow{
      display:flex;
      gap:8px;
      align-items:baseline;
    }
    .metric input{
      width:100%;
      border:none;
      outline:none;
      padding:10px 12px;
      border-radius:12px;
      background:var(--soft);
      font-family:'Montserrat',sans-serif;
      font-weight:900;
      font-size:18px;
      text-align:right;
      min-width:0;
    }
    .metric input:focus{
      box-shadow: inset 0 0 0 2px rgba(37,99,235,.55);
    }
    .metric .unit{
      font-size:11px;
      font-weight:900;
      color:#94a3b8;
      white-space:nowrap;
    }

    /* Charts */
    .chart-wrap{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
      min-width:0;
      overflow:hidden;
    }
    canvas{ max-width:100%; }

    /* Partners table */
    table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    th{
      text-align:left;
      font-size:11px;
      color:#fff;
      background:var(--ink);
      padding:10px;
      border:1px solid var(--ink);
      white-space:nowrap;
    }
    th.center, td.center{ text-align:center; }
    td{
      border:1px solid var(--line);
      padding:0;
      background:#fff;
      min-width:0;
      vertical-align:top;
    }
    td input{
      width:100%;
      border:none;
      outline:none;
      padding:10px;
      font-size:13px;
      font-family:inherit;
      min-width:0;
    }
    td input{ text-align:left; }
    td input[type="number"]{ text-align:center; font-family:'Montserrat',sans-serif; font-weight:900; }
    td input:focus{
      box-shadow: inset 0 0 0 2px rgba(37,99,235,.55);
      background:#f8fafc;
    }

    .tbl-actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
      flex-wrap:wrap;
    }

    /* delete icon button */
    .icon-btn{
      appearance:none;
      border:none;
      cursor:pointer;
      width:32px;
      height:32px;
      border-radius:10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background:var(--soft);
      border:1px solid var(--line);
      transition:.15s transform, .15s background;
    }
    .icon-btn:hover{ background:#eaf0ff; transform:translateY(-1px); }
    .icon-btn svg{ width:18px; height:18px; stroke:#0f172a; }

    /* Topics */
    textarea#topics{
      width:100%;
      min-height: 160px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      outline:none;
      resize:vertical;
      font-size:13px;
      line-height:1.8;
      background:linear-gradient(180deg, #fff, #fffef2);
      min-width:0;
    }
    textarea#topics:focus{
      box-shadow: inset 0 0 0 2px rgba(37,99,235,.55);
    }

    /* Print / PDFï¼ˆ2ãƒšãƒ¼ã‚¸ã«å®‰å®šã—ã¦ã¾ã¨ã¾ã‚‹ï¼‰ */
    @media print{
      @page { size: A4 landscape; margin: 8mm; }

      body{
        background:#fff;
        padding:0;
        overflow:visible;
        display:block;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .app{
        width:100%;
        border:none;
        box-shadow:none;
        border-radius:0;
        overflow:visible;
        zoom: 0.94;
      }
      .actions, .btn, .no-print{ display:none !important; }

      /* â˜…å°åˆ·ã¯ã€Œå·¦ã‚«ãƒ©ãƒ â†’å³ã‚«ãƒ©ãƒ ã€ã‚’2ãƒšãƒ¼ã‚¸ã«åˆ†ã‘ã‚‹ */
      .grid{
        padding:0;
        gap:10px;
        background:#fff;
        grid-template-columns: 1fr;
      }
      .right-col{
        break-before: page;
        page-break-before: always;
      }

      .card{ box-shadow:none; padding:10px; }
      .topbar{ padding:12px 14px; }

      /* æ”¹ãƒšãƒ¼ã‚¸ã®å¤‰ãªç©ºç™½ã‚’æ¸›ã‚‰ã™ */
      .topbar{ break-after: avoid; page-break-after: avoid; }
      .card{ break-inside: avoid; page-break-inside: avoid; }

      /* å°åˆ·æ™‚ã®å¯†åº¦ */
      .metric input{ padding:6px 8px; font-size:14px; border-radius:10px; }
      .metric{ padding:8px; }
      .chart-wrap{ padding:10px; }
      .kpi .num{ font-size:22px; }
      textarea#topics{ min-height:110px; }
      .print-hide{ display:none !important; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="title">
        <h1>BUSINESS MONTHLY REPORT</h1>
        <div class="sub">å…¥åŠ› â†’ è‡ªå‹•é›†è¨ˆ â†’ KPIå¯è¦–åŒ– â†’ ç›®æ¨™æ˜ç¤º â†’ è‡ªå‹•ä¿å­˜</div>
      </div>


      <div class="nav">
        <a class="tab active" href="./index.html">æœˆå ±</a>
        <a class="tab" href="./page2.html">æ³•äººæ´»å‹•</a>
        <a class="tab" href="./view.html">é–²è¦§</a>
        <a class="tab" href="./print.html" target="_blank" rel="noopener">PDFå°åˆ·</a>
      </div>

      <div class="top-controls">
        <div class="chip">
          <div class="p" id="periodLabel">â€”</div>
          <div class="status" id="saveStatus">æœªä¿å­˜</div>
        </div>

        <div class="date-range" title="å½“æœˆå®Ÿç¸¾ã®å¯¾è±¡æœŸé–“">
          <label>å½“æœˆæœŸé–“</label>
          <input type="date" id="periodStart">
          <span style="opacity:.8;">â€“</span>
          <input type="date" id="periodEnd">
        </div>

        <div class="actions">
          <button class="btn" id="btnImport">JSONå–è¾¼</button>
          <button class="btn" id="btnExport">JSONå‡ºåŠ›</button>
          <button class="btn" id="btnReset">åˆæœŸå€¤ã«æˆ»ã™</button>
          <button class="btn primary" id="btnPrint">å°åˆ·ï¼ˆPDFï¼‰</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div style="display:flex;flex-direction:column;gap:16px;min-width:0;">

        <!-- â‘  å½“æœˆå®Ÿç¸¾ + å½“æœˆéå»å®Ÿç¸¾ï¼ˆæœ€ä¸Šæ®µï¼‰ -->
        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot teal"></span>å½“æœˆå®Ÿç¸¾ãƒ»å½“æœˆéå»å®Ÿç¸¾</h2>
            <div class="subline">å½“æœˆæœŸé–“ï¼š<strong id="lblRangeCur">-</strong></div>
          </div>

          <div class="metric-wrap" style="margin-top:0;">
            <!-- Current -->
            <div class="metric-box">
              <div class="metric-head">
                <p class="metric-title">å½“æœˆå®Ÿç¸¾</p>
                <div class="metric-period" id="lblPeriodCur">-</div>
              </div>
              <div class="metric-grid">
                <div class="metric">
                  <div class="mlabel">ç·æ¥å ´</div>
                  <div class="mrow">
                    <input type="number" id="v_totalVisit" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric">
                  <div class="mlabel">ç·å¥‘ç´„</div>
                  <div class="mrow">
                    <input type="number" id="v_totalContract" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric">
                  <div class="mlabel">æ³•äººæ¥å ´</div>
                  <div class="mrow">
                    <input type="number" id="v_corpVisit" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric">
                  <div class="mlabel">æ³•äººå¥‘ç´„</div>
                  <div class="mrow">
                    <input type="number" id="v_corpContract" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric" style="grid-column:1 / -1;">
                  <div class="mlabel">ç´¹ä»‹ã‚«ãƒ¼ãƒ‰</div>
                  <div class="mrow">
                    <input type="number" id="v_referralCards" min="0" step="1">
                    <span class="unit">æš</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Last year same month -->
            <div class="metric-box">
              <div class="metric-head">
                <p class="metric-title">å½“æœˆéå»å®Ÿç¸¾ï¼ˆå‰å¹´åŒæœˆï¼‰</p>
                <div class="metric-period" id="lblPeriodLY">-</div>
              </div>
              <div class="metric-grid">
                <div class="metric">
                  <div class="mlabel">ç·æ¥å ´</div>
                  <div class="mrow">
                    <input type="number" id="ly_totalVisit" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric">
                  <div class="mlabel">ç·å¥‘ç´„</div>
                  <div class="mrow">
                    <input type="number" id="ly_totalContract" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric">
                  <div class="mlabel">æ³•äººæ¥å ´</div>
                  <div class="mrow">
                    <input type="number" id="ly_corpVisit" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric">
                  <div class="mlabel">æ³•äººå¥‘ç´„</div>
                  <div class="mrow">
                    <input type="number" id="ly_corpContract" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric" style="grid-column:1 / -1;">
                  <div class="mlabel">ç´¹ä»‹ã‚«ãƒ¼ãƒ‰</div>
                  <div class="mrow">
                    <input type="number" id="ly_referralCards" min="0" step="1">
                    <span class="unit">æš</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- â‘¡ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰KPIï¼ˆãã®ä¸‹ï¼‰ -->
        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot blue"></span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆä¸»è¦KPIï¼‰</h2>
            <div class="subline">å½“æœˆ <strong id="lblCurMonth">â€”</strong> / å‰å¹´åŒæœˆ</div>
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="label">ç·æ­©ç•™ã‚Šï¼ˆå¥‘ç´„ / æ¥å ´ï¼‰</div>
              <div class="val"><span class="num" id="k_ty">0.0</span><span class="unit">%</span></div>
              <div class="delta neutral" id="d_ty"></div>
            </div>
            <div class="kpi">
              <div class="label">æ³•äººæ¥å ´æ¯”ï¼ˆæ³•äººæ¥å ´ / æ¥å ´ï¼‰</div>
              <div class="val"><span class="num" id="k_cvr">0.0</span><span class="unit">%</span></div>
              <div class="delta neutral" id="d_cvr"></div>
            </div>
            <div class="kpi">
              <div class="label">æ³•äººå¥‘ç´„æ¯”ï¼ˆæ³•äººå¥‘ç´„ / ç·å¥‘ç´„ï¼‰</div>
              <div class="val"><span class="num" id="k_ccr">0.0</span><span class="unit">%</span></div>
              <div class="delta neutral" id="d_ccr"></div>
            </div>
            <div class="kpi">
              <div class="label">æ³•äººæ­©ç•™ã‚Šï¼ˆæ³•äººå¥‘ç´„ / æ³•äººæ¥å ´ï¼‰</div>
              <div class="val"><span class="num" id="k_cy">0.0</span><span class="unit">%</span></div>
              <div class="delta neutral" id="d_cy"></div>
            </div>
          </div>
        </div>

        <!-- â‘¢ æ¬¡æœˆéå»å®Ÿç¸¾ãƒ»æ¬¡æœˆç›®æ¨™ï¼ˆãã®ä¸‹ï¼‰ -->
        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot teal"></span>æ¬¡æœˆéå»å®Ÿç¸¾ãƒ»æ¬¡æœˆç›®æ¨™</h2>
            <div class="subline">æ¬¡æœˆé–¢é€£</div>
          </div>

          <div class="metric-wrap" style="margin-top:0;">
            <!-- Next month past -->
            <div class="metric-box">
              <div class="metric-head">
                <p class="metric-title">æ¬¡æœˆéå»å®Ÿç¸¾</p>
                <div class="metric-period" id="lblPeriodNextPast">-</div>
              </div>

              <div class="metric-grid">
                <div class="metric">
                  <div class="mlabel">ç·æ¥å ´</div>
                  <div class="mrow">
                    <input type="number" id="nm_totalVisit" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric">
                  <div class="mlabel">ç·å¥‘ç´„</div>
                  <div class="mrow">
                    <input type="number" id="nm_totalContract" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric">
                  <div class="mlabel">æ³•äººæ¥å ´</div>
                  <div class="mrow">
                    <input type="number" id="nm_corpVisit" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric">
                  <div class="mlabel">æ³•äººå¥‘ç´„</div>
                  <div class="mrow">
                    <input type="number" id="nm_corpContract" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric" style="grid-column:1 / -1;">
                  <div class="mlabel">ç´¹ä»‹ã‚«ãƒ¼ãƒ‰</div>
                  <div class="mrow">
                    <input type="number" id="nm_referralCards" min="0" step="1">
                    <span class="unit">æš</span>
                  </div>
                </div>

                <div class="metric" style="grid-column:1 / -1;">
                  <div class="mlabel">å‚è€ƒKPIï¼ˆè‡ªå‹•ç®—å‡ºï¼‰</div>
                  <div style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px;">
                    <div class="highlight" style="padding:10px; border-left:6px solid var(--teal);">
                      <div class="left">
                        <div class="t">æ³•äººæ¥å ´å‰²åˆ</div>
                        <div style="font-family:'Montserrat',sans-serif;font-weight:900;font-size:22px;" id="nm_k_cvr">0.0%</div>
                      </div>
                      <div class="badge">â€”</div>
                    </div>
                    <div class="highlight" style="padding:10px; border-left:6px solid var(--blue);">
                      <div class="left">
                        <div class="t">æ³•äººæ­©ç•™ã‚Š</div>
                        <div style="font-family:'Montserrat',sans-serif;font-weight:900;font-size:22px;" id="nm_k_cy">0.0%</div>
                      </div>
                      <div class="badge">â€”</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Next month target -->
            <div class="metric-box">
              <div class="metric-head">
                <p class="metric-title">æ¬¡æœˆç›®æ¨™</p>
                <div class="metric-period" id="lblPeriodNextTarget">-</div>
              </div>

              <div class="metric-grid">
                <div class="metric">
                  <div class="mlabel">ç·æ¥å ´ï¼ˆç›®æ¨™ï¼‰</div>
                  <div class="mrow">
                    <input type="number" id="tg_totalVisit" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric">
                  <div class="mlabel">ç·å¥‘ç´„ï¼ˆç›®æ¨™ï¼‰</div>
                  <div class="mrow">
                    <input type="number" id="tg_totalContract" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric">
                  <div class="mlabel">æ³•äººæ¥å ´ï¼ˆç›®æ¨™ï¼‰</div>
                  <div class="mrow">
                    <input type="number" id="tg_corpVisit" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric">
                  <div class="mlabel">æ³•äººå¥‘ç´„ï¼ˆç›®æ¨™ï¼‰</div>
                  <div class="mrow">
                    <input type="number" id="tg_corpContract" min="0" step="1">
                    <span class="unit">ä»¶</span>
                  </div>
                </div>
                <div class="metric" style="grid-column:1 / -1;">
                  <div class="mlabel">ç´¹ä»‹ã‚«ãƒ¼ãƒ‰ï¼ˆç›®æ¨™ï¼‰</div>
                  <div class="mrow">
                    <input type="number" id="tg_referralCards" min="0" step="1">
                    <span class="unit">æš</span>
                  </div>
                </div>

                <!-- â˜…å¤‰æ›´ï¼šç›®æ¨™KPIã‹ã‚‰ã€Œç·æ­©ç•™ã‚Šã€ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ï¼ˆæ³•äººæ¥å ´å‰²åˆï¼æ³•äººæ­©ç•™ã‚Šã®ã¿ï¼‰ -->
                <div class="metric" style="grid-column:1 / -1;">
                  <div class="mlabel">ç›®æ¨™KPIï¼ˆè‡ªå‹•ç®—å‡ºï¼‰</div>
                  <div style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px;">
                    <div class="highlight" style="padding:10px; border-left:6px solid var(--teal);">
                      <div class="left">
                        <div class="t">æ³•äººæ¥å ´å‰²åˆ</div>
                        <div style="font-family:'Montserrat',sans-serif;font-weight:900;font-size:22px;" id="tg_k_cvr">0.0%</div>
                      </div>
                      <div class="badge">â€”</div>
                    </div>

                    <div class="highlight" style="padding:10px; border-left:6px solid var(--blue);">
                      <div class="left">
                        <div class="t">æ³•äººæ­©ç•™ã‚Š</div>
                        <div style="font-family:'Montserrat',sans-serif;font-weight:900;font-size:22px;" id="tg_k_cy">0.0%</div>
                      </div>
                      <div class="badge" id="tg_hint_cy">â€”</div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </div>

        <!-- â‘£ ä¼šç¤¾æ•°ï¼ˆãã®ä¸‹ï¼‰ -->
        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot amber"></span>ææºä¼šç¤¾æ•°ãƒ»å¯¾è±¡ä¼æ¥­æ•°</h2>
            <div class="subline"><strong id="badgeCoverage">â€”</strong></div>
          </div>

          <div class="highlights">
            <div class="highlight" style="border-left:6px solid var(--amber);">
              <div class="left">
                <div class="t">ææºä¼šç¤¾æ•°</div>
                <input class="big-input" type="number" id="companyCount" min="0" step="1">
              </div>
              <div class="badge">PARTNERS</div>
            </div>

            <div class="highlight" style="border-left:6px solid var(--violet);">
              <div class="left">
                <div class="t">å¯¾è±¡ä¼æ¥­ç·æ•°</div>
                <input class="big-input" type="number" id="targetCount" min="0" step="1">
              </div>
              <div class="badge">TARGETS</div>
            </div>
          </div>
        </div>

        <!-- â‘¤ ææºå…ˆå…¥åŠ›ï¼ˆæœ€å¾Œï¼‰ -->
        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot amber"></span>ææºå…ˆï¼ˆå…¥åŠ›ãƒ»é›†è¨ˆï¼‰</h2>
            <div class="subline">
              åˆè¨ˆï¼šæ¥å ´ <strong id="sumPartnerVisit">0</strong> /
              å¥‘ç´„ <strong id="sumPartnerContract">0</strong> /
              åˆå› <strong id="sumPartnerFirst">0</strong> /
              ç”³è¾¼ <strong id="sumPartnerApply">0</strong>
            </div>
          </div>

          <div class="print-hide" style="overflow:hidden;">
            <table>
  <colgroup>
    <col style="width:20%;">
    <col style="width:46%;"> <!-- å¯¾è±¡ç‰©ä»¶åã‚’åºƒã’ã‚‹ -->
    <col style="width:7%;">
    <col style="width:7%;">
    <col style="width:7%;">
    <col style="width:7%;">
    <col style="width:6%;">  <!-- å‰Šé™¤ -->
  </colgroup>
  <thead>
    <tr>
      <th>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¼æ¥­å</th>
      <th>å¯¾è±¡ç‰©ä»¶å</th>
      <th class="center">æ¥å ´</th>
      <th class="center">å¥‘ç´„</th>
      <th class="center">åˆå›</th>
      <th class="center">ç”³è¾¼</th>
      <th class="center"><span aria-label="å‰Šé™¤" title="å‰Šé™¤">ğŸ—‘</span></th>
    </tr>
  </thead>
  <tbody id="partnersBody"></tbody>
</table>

          </div>

          <div class="tbl-actions print-hide">
            <button class="btn primary" id="btnAddRow">è¡Œè¿½åŠ </button>
            <span class="subline">â€»åˆå›ãƒ»ç”³è¾¼ã¯ã€Œç´¹ä»‹ã‚«ãƒ¼ãƒ‰ã€ã®ä»¶æ•°</span>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="right-col" style="display:flex;flex-direction:column;gap:16px;min-width:0;">

        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot blue"></span>KPIï¼ˆ%ï¼‰ å½“æœˆ vs å‰å¹´åŒæœˆ</h2>
            <div class="subline">ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¡¨ç¤º</div>
          </div>
          <div class="chart-wrap">
            <canvas id="chartKPI" height="200"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot teal"></span>ãƒ•ã‚¡ãƒãƒ«ï¼ˆæ­©ç•™ã‚Šï¼‰</h2>
            <div class="subline">ä¸Šé™ç›®å®‰ 30%</div>
          </div>
          <div class="chart-wrap">
            <canvas id="chartFunnel" height="210"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot teal"></span>æ³•äººæ¯”ç‡ï¼ˆæ¥å ´ï¼‰</h2>
            <div class="subline">ä¸­å¤®ã«%è¡¨ç¤º</div>
          </div>
          <div class="chart-wrap">
            <canvas id="chartShare" height="180"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot amber"></span>ææºå…ˆ ä¸Šä½ï¼ˆæ¥å ´ / å¥‘ç´„ / åˆå› / ç”³è¾¼ï¼‰</h2>
            <div class="subline">ä¸Šä½8ç¤¾</div>
          </div>
          <div class="chart-wrap">
            <canvas id="chartPartners" height="240"></canvas>
          </div>
        </div>
      </div>

      <div class="topics-row" style="grid-column:1 / -1; min-width:0;">
                <div class="card">
                  <div class="hrow">
                    <h2 class="h2"><span class="dot violet"></span>Topicsï¼ˆãƒ¡ãƒ¢ï¼‰</h2>
                    <div class="subline">é‡è¦è«–ç‚¹ï¼æ¬¡æœˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
                  </div>
                  <textarea id="topics" placeholder="ãƒ»ä»Šæœˆã®ç‰¹ç­†äº‹é …
        ãƒ»æ–°è¦ææºä¼æ¥­ã®åå¿œ
        ãƒ»æ¬¡æœˆã¸ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"></textarea>
                </div>
      </div>

    </div>
  </div>

<script>
(function(){
  const clone = (obj) => (window.structuredClone ? structuredClone(obj) : JSON.parse(JSON.stringify(obj)));

  // ===================== Helpers (dates) =====================
  const pad2 = (n) => String(n).padStart(2,"0");
  const toISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const fmtJP = (iso) => {
    if(!iso) return "-";
    const [y,m,d] = String(iso).split("-").map(Number);
    return `${y}/${pad2(m)}/${pad2(d)}`;
  };
  function monthStartEnd(year, month1to12){
    const start = new Date(year, month1to12-1, 1);
    const end = new Date(year, month1to12, 0);
    return { start: toISO(start), end: toISO(end) };
  }
  function addMonths(year, month1to12, delta){
    let m = (month1to12 - 1) + delta;
    let y = year + Math.floor(m / 12);
    m = m % 12;
    if(m < 0){ m += 12; y -= 1; }
    return { year: y, month: m+1 };
  }
  function derivePeriodLabelFromStart(isoStart){
    if(!isoStart) return "â€”";
    const [y,m] = String(isoStart).split("-").map(Number);
    if(!y || !m) return "â€”";
    return `${y}.${pad2(m)}`;
  }
  function monthNowLabel(isoStart){
    if(!isoStart) return "â€”";
    const [y,m] = String(isoStart).split("-").map(Number);
    if(!y || !m) return "â€”";
    return `${y}å¹´${m}æœˆç¾åœ¨`;
  }

  // ===================== State =====================
  const STORAGE_KEY = "hb_monthly_report_state_v3";

  const DEFAULT_STATE = (() => {
    const now = new Date();
    const cur = monthStartEnd(now.getFullYear(), now.getMonth()+1);
    return {
      meta: { periodStart: cur.start, periodEnd: cur.end },
      counts: { partnerCompanies: 0, targetCompanies: 0 },
      perf: { totalVisit: 0, totalContract: 0, corpVisit: 0, corpContract: 0, referralCards: 0 },
      lastYear: { totalVisit: 0, totalContract: 0, corpVisit: 0, corpContract: 0, referralCards: 0 },
      nextMonthPast: { totalVisit: 0, totalContract: 0, corpVisit: 0, corpContract: 0, referralCards: 0 },
      nextTarget: { totalVisit: 0, totalContract: 0, corpVisit: 0, corpContract: 0, referralCards: 0 },
      partners: [{ name: "", property: "", visit: 0, contract: 0, first: 0, apply: 0 }],
      reportPartners: [{ name: "", property: "", visit: 0, contract: 0, first: 0, apply: 0 }],
      reportPartnersYM: cur.start.slice(0,7),
      topics: ""
    };
  })();

  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return clone(DEFAULT_STATE);
    try{
      const parsed = JSON.parse(raw);
      const s = clone(DEFAULT_STATE);
      const out = {
        ...s,
        ...parsed,
        meta: { ...s.meta, ...(parsed.meta||{}) },
        counts: { ...s.counts, ...(parsed.counts||{}) },
        perf: { ...s.perf, ...(parsed.perf||{}) },
        lastYear: { ...s.lastYear, ...(parsed.lastYear||{}) },
        nextMonthPast: { ...s.nextMonthPast, ...(parsed.nextMonthPast||{}) },
        nextTarget: { ...s.nextTarget, ...(parsed.nextTarget||{}) },
        partners: Array.isArray(parsed.partners) && parsed.partners.length ? parsed.partners : clone(s.partners),
        topics: typeof parsed.topics === "string" ? parsed.topics : ""
      };

      out.partners = out.partners.map(p => ({
        name: p?.name ?? "",
        property: p?.property ?? "",
        visit: Number(p?.visit ?? 0) || 0,
        contract: Number(p?.contract ?? 0) || 0,
        first: Number(p?.first ?? 0) || 0,
        apply: Number(p?.apply ?? 0) || 0
      }));

      return out;
    }catch{
      return clone(DEFAULT_STATE);
    }
  }

  loadPublicState().then(state => {
  render(state);
});

  // ===================== Utilities =====================
  const $ = (id) => document.getElementById(id);
  const nfInt = new Intl.NumberFormat("ja-JP");

  function clamp0(n){ n = Number(n); return Number.isFinite(n) && n>0 ? n : 0; }
  function pct(a,b){ return (b>0) ? (a/b)*100 : 0; }
  function fmt1(n){ return (Number.isFinite(n) ? n : 0).toFixed(1); }

  function setSaveStatus(text){ $("saveStatus").textContent = text; }
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    setSaveStatus("ä¿å­˜æ¸ˆã¿");
  }

  // ===================== KPI / Deltas =====================
  function setDelta(elId, now, base){
    const el = $(elId);
    const diff = now - base;
    const sign = diff > 0 ? "+" : "";
    const cls = (Math.abs(diff) < 0.05) ? "neutral" : (diff > 0 ? "good" : "bad");
    el.className = "delta " + cls;

    const tag = document.createElement("span");
    tag.className = "tag";
    tag.textContent = `å‰å¹´å·® ${sign}${fmt1(diff)}pt`;

    const small = document.createElement("span");
    small.textContent = `ï¼ˆå‰å¹´ ${fmt1(base)}%ï¼‰`;

    el.innerHTML = "";
    el.appendChild(tag);
    el.appendChild(small);
  }

  // ===================== Charts =====================
  const HAS_CHART = (typeof window.Chart !== "undefined");
  let chartKPI, chartFunnel, chartShare, chartPartners;

  const centerLabelPlugin = {
    id: "centerLabel",
    afterDraw(chart){
      if(chart.config.type !== "doughnut") return;
      const {ctx, chartArea} = chart;
      if(!chartArea) return;

      const data = chart.data.datasets?.[0]?.data || [];
      const corp = Number(data[0] || 0);
      const total = data.reduce((a,b)=>a+Number(b||0), 0);
      const p = total ? (corp/total*100) : 0;

      const cx = (chartArea.left + chartArea.right) / 2;
      const cy = (chartArea.top + chartArea.bottom) / 2;

      ctx.save();
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "#0f172a";
      ctx.font = "800 26px Montserrat, sans-serif";
      ctx.fillText(p.toFixed(1) + "%", cx, cy - 6);
      ctx.fillStyle = "#64748b";
      ctx.font = "700 11px Noto Sans JP, sans-serif";
      ctx.fillText("æ³•äººæ¯”ç‡ï¼ˆæ¥å ´ï¼‰", cx, cy + 18);
      ctx.restore();
    }
  };

  function initCharts(){
    if(!HAS_CHART){
      console.warn("Chart.js ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ¶é™ã®å¯èƒ½æ€§ï¼‰ã€‚");
      return;
    }
    Chart.register(centerLabelPlugin);

    const C = {
      blueBg:"rgba(37,99,235,0.35)", blueBd:"rgba(37,99,235,1)",
      redBg:"rgba(220,38,38,0.25)",  redBd:"rgba(220,38,38,1)",
      tealBg:"rgba(14,165,233,0.35)", tealBd:"rgba(14,165,233,1)",
      amberBg:"rgba(245,158,11,0.35)", amberBd:"rgba(245,158,11,1)",
      pinkBg:"rgba(244,63,94,0.25)",  pinkBd:"rgba(244,63,94,1)",
    };

    chartKPI = new Chart($("chartKPI"), {
      type: "bar",
      data: {
        labels: ["ç·æ­©ç•™ã‚Š","æ³•äººæ¥å ´æ¯”","æ³•äººå¥‘ç´„æ¯”","æ³•äººæ­©ç•™ã‚Š"],
        datasets: [
          { label: "å½“æœˆ", data: [0,0,0,0], backgroundColor:C.blueBg, borderColor:C.blueBd, borderWidth:1 },
          { label: "å‰å¹´åŒæœˆ", data: [0,0,0,0], backgroundColor:C.pinkBg, borderColor:C.pinkBd, borderWidth:1 }
        ]
      },
      options: {
        responsive:true,
        plugins:{ legend:{ position:"top" } },
        scales:{ y:{ beginAtZero:true, suggestedMax: 30, ticks:{ callback:(v)=> v + "%" } } }
      }
    });

    chartFunnel = new Chart($("chartFunnel"), {
      type: "bar",
      data: {
        labels: ["æ¥å ´ â†’ å¥‘ç´„", "æ³•äººæ¥å ´ â†’ æ³•äººå¥‘ç´„"],
        datasets: [{ label: "æ­©ç•™ã‚Š(%)", data: [0,0], backgroundColor:C.tealBg, borderColor:C.tealBd, borderWidth:1 }]
      },
      options: {
        indexAxis: "y",
        responsive:true,
        plugins:{ legend:{ display:false } },
        scales:{ x:{ beginAtZero:true, suggestedMax: 30, ticks:{ callback:(v)=> v + "%" } } }
      }
    });

    chartShare = new Chart($("chartShare"), {
      type: "doughnut",
      data: {
        labels: ["æ³•äºº","éæ³•äºº"],
        datasets: [{
          data: [0,0],
          backgroundColor:[ "rgba(37,99,235,0.55)", "rgba(244,63,94,0.35)" ],
          borderColor:[ "rgba(37,99,235,1)", "rgba(244,63,94,1)" ],
          borderWidth:1,
          cutout:"62%"
        }]
      },
      options: { responsive:true, plugins:{ legend:{ position:"bottom" } } }
    });

    chartPartners = new Chart($("chartPartners"), {
      type: "bar",
      data: {
        labels: [],
        datasets: [
          { label:"æ¥å ´", data: [], backgroundColor:C.blueBg, borderColor:C.blueBd, borderWidth:1 },
          { label:"å¥‘ç´„", data: [], backgroundColor:C.redBg, borderColor:C.redBd, borderWidth:1 },
          { label:"åˆå›", data: [], backgroundColor:C.tealBg, borderColor:C.tealBd, borderWidth:1 },
          { label:"ç”³è¾¼", data: [], backgroundColor:C.amberBg, borderColor:C.amberBd, borderWidth:1 }
        ]
      },
      options: {
        indexAxis: "y",
        responsive:true,
        plugins:{ legend:{ position:"top" } },
        scales:{ x:{ beginAtZero:true, ticks:{ precision:0 } } }
      }
    });

    // â˜…å°åˆ·æ™‚ã«ãƒãƒ£ãƒ¼ãƒˆãŒã‚ºãƒ¬ã‚‹å¯¾ç­–
    window.addEventListener("beforeprint", ()=>{
      [chartKPI, chartFunnel, chartShare, chartPartners].forEach(c=>{
        try{ c && c.resize(); c && c.update(); }catch(e){}
      });
    });
  }

  function updateCharts(){
    if(!HAS_CHART || !chartKPI) return;

    const c = state.perf;
    const ly = state.lastYear;

    const k_ty  = pct(c.totalContract, c.totalVisit);
    const k_cvr = pct(c.corpVisit, c.totalVisit);
    const k_ccr = pct(c.corpContract, c.totalContract);
    const k_cy  = pct(c.corpContract, c.corpVisit);

    const ly_ty  = pct(ly.totalContract, ly.totalVisit);
    const ly_cvr = pct(ly.corpVisit, ly.totalVisit);
    const ly_ccr = pct(ly.corpContract, ly.totalContract);
    const ly_cy  = pct(ly.corpContract, ly.corpVisit);

    chartKPI.data.datasets[0].data = [Number(fmt1(k_ty)), Number(fmt1(k_cvr)), Number(fmt1(k_ccr)), Number(fmt1(k_cy))];
    chartKPI.data.datasets[1].data = [Number(fmt1(ly_ty)), Number(fmt1(ly_cvr)), Number(fmt1(ly_ccr)), Number(fmt1(ly_cy))];
    chartKPI.update();

    chartFunnel.data.datasets[0].data = [Number(fmt1(k_ty)), Number(fmt1(k_cy))];
    chartFunnel.update();

    const nonCorp = Math.max(0, clamp0(c.totalVisit) - clamp0(c.corpVisit));
    chartShare.data.datasets[0].data = [clamp0(c.corpVisit), nonCorp];
    chartShare.update();

    const rows = (state.reportPartners || [])
      .map(p=>({
        name: (p.name || "ï¼ˆæœªå…¥åŠ›ï¼‰").trim(),
        visit: clamp0(p.visit),
        contract: clamp0(p.contract),
        first: clamp0(p.first),
        apply: clamp0(p.apply)
      }))
      .filter(x => x.visit>0 || x.contract>0 || x.first>0 || x.apply>0);

    rows.sort((a,b)=> (b.visit+b.contract+b.first+b.apply) - (a.visit+a.contract+a.first+a.apply));
    const top = rows.slice(0, 8);

    chartPartners.data.labels = top.map(x=>x.name);
    chartPartners.data.datasets[0].data = top.map(x=>x.visit);
    chartPartners.data.datasets[1].data = top.map(x=>x.contract);
    chartPartners.data.datasets[2].data = top.map(x=>x.first);
    chartPartners.data.datasets[3].data = top.map(x=>x.apply);
    chartPartners.update();
  }

  // ===================== Period labels =====================
  function recalcPeriodsUI(){
    const curStart = state.meta.periodStart;
    const curEnd = state.meta.periodEnd;

    const period = derivePeriodLabelFromStart(curStart);
    $("periodLabel").textContent = period;
    $("lblCurMonth").textContent = period;

    $("lblRangeCur").textContent = `${fmtJP(curStart)} â€“ ${fmtJP(curEnd)}`;
    $("lblPeriodCur").textContent = `${fmtJP(curStart)} â€“ ${fmtJP(curEnd)}`;

    const [yStr, mStr] = String(curStart || "").split("-");
    const year = Number(yStr);
    const month = Number(mStr);

    if(year && month){
      const lyRange = monthStartEnd(year - 1, month);
      $("lblPeriodLY").textContent = `${fmtJP(lyRange.start)} â€“ ${fmtJP(lyRange.end)}`;

      const next = addMonths(year, month, 1);
      const nextRange = monthStartEnd(next.year, next.month);
      $("lblPeriodNextTarget").textContent = `${next.year}.${pad2(next.month)}ï¼ˆ${fmtJP(nextRange.start)} â€“ ${fmtJP(nextRange.end)}ï¼‰`;

      const nextPast = monthStartEnd(next.year - 1, next.month);
      $("lblPeriodNextPast").textContent = `${(next.year-1)}.${pad2(next.month)}ï¼ˆ${fmtJP(nextPast.start)} â€“ ${fmtJP(nextPast.end)}ï¼‰`;
    }else{
      $("lblPeriodLY").textContent = "-";
      $("lblPeriodNextTarget").textContent = "-";
      $("lblPeriodNextPast").textContent = "-";
    }

    $("badgeCoverage").textContent = monthNowLabel(curStart);
  }

  // ===================== Partners table =====================
  function trashSvg(){
    return `
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M3 6h18"></path>
        <path d="M8 6V4h8v2"></path>
        <path d="M19 6l-1 14H6L5 6"></path>
        <path d="M10 11v6"></path>
        <path d="M14 11v6"></path>
      </svg>
    `;
  }

  function renderPartners(){
    const tbody = $("partnersBody");
    tbody.innerHTML = "";

    (state.reportPartners || []).forEach((p, idx)=>{
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      const iName = document.createElement("input");
      iName.value = p.name || "";
      iName.placeholder = "ä¾‹ï¼šãƒ™ãƒ«ã‚¹";
      iName.addEventListener("input", ()=>{
        p.name = iName.value;
        setSaveStatus("ç·¨é›†ä¸­â€¦");
        recalcAll(); saveState();
      });
      tdName.appendChild(iName);

      const tdProp = document.createElement("td");
      const iProp = document.createElement("input");
      iProp.value = p.property || "";
      iProp.placeholder = "ä¾‹ï¼šLPæµ¦å’Œç¥æ˜";
      iProp.addEventListener("input", ()=>{
        p.property = iProp.value;
        setSaveStatus("ç·¨é›†ä¸­â€¦");
        recalcAll(); saveState();
      });
      tdProp.appendChild(iProp);

      const tdVisit = document.createElement("td");
      tdVisit.className = "center";
      const iVisit = document.createElement("input");
      iVisit.type = "number"; iVisit.min="0"; iVisit.step="1";
      iVisit.value = clamp0(p.visit);
      iVisit.addEventListener("input", ()=>{
        p.visit = clamp0(iVisit.value);
        setSaveStatus("ç·¨é›†ä¸­â€¦");
        recalcAll(); saveState();
      });
      tdVisit.appendChild(iVisit);

      const tdContract = document.createElement("td");
      tdContract.className = "center";
      const iContract = document.createElement("input");
      iContract.type = "number"; iContract.min="0"; iContract.step="1";
      iContract.value = clamp0(p.contract);
      iContract.addEventListener("input", ()=>{
        p.contract = clamp0(iContract.value);
        setSaveStatus("ç·¨é›†ä¸­â€¦");
        recalcAll(); saveState();
      });
      tdContract.appendChild(iContract);

      const tdFirst = document.createElement("td");
      tdFirst.className = "center";
      const iFirst = document.createElement("input");
      iFirst.type="number"; iFirst.min="0"; iFirst.step="1";
      iFirst.value = clamp0(p.first);
      iFirst.addEventListener("input", ()=>{
        p.first = clamp0(iFirst.value);
        setSaveStatus("ç·¨é›†ä¸­â€¦");
        recalcAll(); saveState();
      });
      tdFirst.appendChild(iFirst);

      const tdApply = document.createElement("td");
      tdApply.className = "center";
      const iApply = document.createElement("input");
      iApply.type="number"; iApply.min="0"; iApply.step="1";
      iApply.value = clamp0(p.apply);
      iApply.addEventListener("input", ()=>{
        p.apply = clamp0(iApply.value);
        setSaveStatus("ç·¨é›†ä¸­â€¦");
        recalcAll(); saveState();
      });
      tdApply.appendChild(iApply);

      const tdDel = document.createElement("td");
      tdDel.className = "center";
      tdDel.style.padding="6px";
      const b = document.createElement("button");
      b.className = "icon-btn";
      b.type = "button";
      b.title = "å‰Šé™¤";
      b.setAttribute("aria-label","å‰Šé™¤");
      b.innerHTML = trashSvg();
      b.addEventListener("click", ()=>{
        state.reportPartners.splice(idx, 1);
        if(state.reportPartners.length === 0){
          state.reportPartners.push({ name:"", property:"", visit:0, contract:0, first:0, apply:0 });
        }
        renderPartners();
        recalcAll();
        saveState();
      });
      tdDel.appendChild(b);

      [tdName, tdProp, tdVisit, tdContract, tdFirst, tdApply, tdDel].forEach(td=>tr.appendChild(td));
      tbody.appendChild(tr);
    });
  }

  // ===================== UI sync =====================
  function setUIFromState(){
    $("periodStart").value = state.meta.periodStart || "";
    $("periodEnd").value = state.meta.periodEnd || "";

    $("companyCount").value = clamp0(state.counts.partnerCompanies);
    $("targetCount").value = clamp0(state.counts.targetCompanies);

    const c = state.perf;
    $("v_totalVisit").value = clamp0(c.totalVisit);
    $("v_totalContract").value = clamp0(c.totalContract);
    $("v_corpVisit").value = clamp0(c.corpVisit);
    $("v_corpContract").value = clamp0(c.corpContract);
    $("v_referralCards").value = clamp0(c.referralCards);

    const ly = state.lastYear;
    $("ly_totalVisit").value = clamp0(ly.totalVisit);
    $("ly_totalContract").value = clamp0(ly.totalContract);
    $("ly_corpVisit").value = clamp0(ly.corpVisit);
    $("ly_corpContract").value = clamp0(ly.corpContract);
    $("ly_referralCards").value = clamp0(ly.referralCards);

    const nm = state.nextMonthPast;
    $("nm_totalVisit").value = clamp0(nm.totalVisit);
    $("nm_totalContract").value = clamp0(nm.totalContract);
    $("nm_corpVisit").value = clamp0(nm.corpVisit);
    $("nm_corpContract").value = clamp0(nm.corpContract);
    $("nm_referralCards").value = clamp0(nm.referralCards);

    const tg = state.nextTarget;
    $("tg_totalVisit").value = clamp0(tg.totalVisit);
    $("tg_totalContract").value = clamp0(tg.totalContract);
    $("tg_corpVisit").value = clamp0(tg.corpVisit);
    $("tg_corpContract").value = clamp0(tg.corpContract);
    $("tg_referralCards").value = clamp0(tg.referralCards);

    $("topics").value = state.topics || "";

    recalcPeriodsUI();
  }

  function readInputsToState(){
    state.meta.periodStart = $("periodStart").value;
    state.meta.periodEnd = $("periodEnd").value;
    state.reportPartnersYM = String(state.meta.periodStart||"").slice(0,7);

    state.counts.partnerCompanies = clamp0($("companyCount").value);
    state.counts.targetCompanies = clamp0($("targetCount").value);

    state.perf.totalVisit = clamp0($("v_totalVisit").value);
    state.perf.totalContract = clamp0($("v_totalContract").value);
    state.perf.corpVisit = clamp0($("v_corpVisit").value);
    state.perf.corpContract = clamp0($("v_corpContract").value);
    state.perf.referralCards = clamp0($("v_referralCards").value);

    state.lastYear.totalVisit = clamp0($("ly_totalVisit").value);
    state.lastYear.totalContract = clamp0($("ly_totalContract").value);
    state.lastYear.corpVisit = clamp0($("ly_corpVisit").value);
    state.lastYear.corpContract = clamp0($("ly_corpContract").value);
    state.lastYear.referralCards = clamp0($("ly_referralCards").value);

    state.nextMonthPast.totalVisit = clamp0($("nm_totalVisit").value);
    state.nextMonthPast.totalContract = clamp0($("nm_totalContract").value);
    state.nextMonthPast.corpVisit = clamp0($("nm_corpVisit").value);
    state.nextMonthPast.corpContract = clamp0($("nm_corpContract").value);
    state.nextMonthPast.referralCards = clamp0($("nm_referralCards").value);

    state.nextTarget.totalVisit = clamp0($("tg_totalVisit").value);
    state.nextTarget.totalContract = clamp0($("tg_totalContract").value);
    state.nextTarget.corpVisit = clamp0($("tg_corpVisit").value);
    state.nextTarget.corpContract = clamp0($("tg_corpContract").value);
    state.nextTarget.referralCards = clamp0($("tg_referralCards").value);

    state.topics = $("topics").value;
  }

  // ===================== Recalc =====================
  function recalcAll(){
    const c = state.perf;
    const ly = state.lastYear;

    const k_ty  = pct(c.totalContract, c.totalVisit);
    const k_cvr = pct(c.corpVisit, c.totalVisit);
    const k_ccr = pct(c.corpContract, c.totalContract);
    const k_cy  = pct(c.corpContract, c.corpVisit);

    $("k_ty").textContent  = fmt1(k_ty);
    $("k_cvr").textContent = fmt1(k_cvr);
    $("k_ccr").textContent = fmt1(k_ccr);
    $("k_cy").textContent  = fmt1(k_cy);

    const ly_ty  = pct(ly.totalContract, ly.totalVisit);
    const ly_cvr = pct(ly.corpVisit, ly.totalVisit);
    const ly_ccr = pct(ly.corpContract, ly.totalContract);
    const ly_cy  = pct(ly.corpContract, ly.corpVisit);

    setDelta("d_ty",  k_ty,  ly_ty);
    setDelta("d_cvr", k_cvr, ly_cvr);
    setDelta("d_ccr", k_ccr, ly_ccr);
    setDelta("d_cy",  k_cy,  ly_cy);

    // Partners sums
    const sumV = (state.reportPartners||[]).reduce((s,p)=> s + clamp0(p.visit), 0);
    const sumC = (state.reportPartners||[]).reduce((s,p)=> s + clamp0(p.contract), 0);
    const sumF = (state.reportPartners||[]).reduce((s,p)=> s + clamp0(p.first), 0);
    const sumA = (state.reportPartners||[]).reduce((s,p)=> s + clamp0(p.apply), 0);
    $("sumPartnerVisit").textContent = nfInt.format(sumV);
    $("sumPartnerContract").textContent = nfInt.format(sumC);
    $("sumPartnerFirst").textContent = nfInt.format(sumF);
    $("sumPartnerApply").textContent = nfInt.format(sumA);

    // æ¬¡æœˆéå» KPI
    const nm = state.nextMonthPast;
    const nm_cvr = pct(nm.corpVisit, nm.totalVisit);
    const nm_cy  = pct(nm.corpContract, nm.corpVisit);
    $("nm_k_cvr").textContent = `${fmt1(nm_cvr)}%`;
    $("nm_k_cy").textContent  = `${fmt1(nm_cy)}%`;

    // â˜…ç›®æ¨™ KPIï¼ˆç·æ­©ç•™ã‚Šã¯å‰Šé™¤ã—ãŸã®ã§è¨ˆç®—ãƒ»è¡¨ç¤ºã—ãªã„ï¼‰
    const tg = state.nextTarget;
    const tg_cvr = pct(tg.corpVisit, tg.totalVisit);
    const tg_cy  = pct(tg.corpContract, tg.corpVisit);
    $("tg_k_cvr").textContent = `${fmt1(tg_cvr)}%`;
    $("tg_k_cy").textContent  = `${fmt1(tg_cy)}%`;
    $("tg_hint_cy").textContent = "â€”";

    updateCharts();
  }

  // ===================== JSON import/export/reset/print =====================
  function exportJSON(){
    const period = derivePeriodLabelFromStart(state.meta.periodStart).replace(".","-");
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `hb_monthly_report_${period || "data"}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function importJSON(){
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = async () => {
      const file = inp.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const obj = JSON.parse(text);

        const s = clone(DEFAULT_STATE);
        state = {
          ...s,
          ...obj,
          meta: { ...s.meta, ...(obj.meta||{}) },
          counts: { ...s.counts, ...(obj.counts||{}) },
          perf: { ...s.perf, ...(obj.perf||{}) },
          lastYear: { ...s.lastYear, ...(obj.lastYear||{}) },
          nextMonthPast: { ...s.nextMonthPast, ...(obj.nextMonthPast||{}) },
          nextTarget: { ...s.nextTarget, ...(obj.nextTarget||{}) },
          partners: Array.isArray(obj.partners) && obj.partners.length ? obj.partners : clone(s.partners),
          reportPartners: Array.isArray(obj.reportPartners) && obj.reportPartners.length ? obj.reportPartners : clone(s.reportPartners),
          reportPartnersYM: typeof obj.reportPartnersYM==="string" ? obj.reportPartnersYM : String((obj.meta||{}).periodStart||s.meta.periodStart||"").slice(0,7),
          topics: typeof obj.topics === "string" ? obj.topics : ""
        };

        state.reportPartners = state.reportPartners.map(p => ({
          name: p?.name ?? "",
          property: p?.property ?? "",
          visit: Number(p?.visit ?? 0) || 0,
          contract: Number(p?.contract ?? 0) || 0,
          first: Number(p?.first ?? 0) || 0,
          apply: Number(p?.apply ?? 0) || 0
        }));

        setUIFromState();
        renderPartners();
        recalcAll();
        saveState();
      }catch(e){
        alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    };
    inp.click();
  }

  function resetAll(){
    state = clone(DEFAULT_STATE);
    localStorage.removeItem(STORAGE_KEY);
    setUIFromState();
    renderPartners();
    recalcAll();
    saveState();
  }

  // ===================== Events =====================
  function attachEventsOnce(){
    const onAnyInput = () => {
      setSaveStatus("ç·¨é›†ä¸­â€¦");
      readInputsToState();
      recalcPeriodsUI();
      recalcAll();
      saveState();
    };

    [
      "periodStart","periodEnd",
      "companyCount","targetCount",
      "v_totalVisit","v_totalContract","v_corpVisit","v_corpContract","v_referralCards",
      "ly_totalVisit","ly_totalContract","ly_corpVisit","ly_corpContract","ly_referralCards",
      "nm_totalVisit","nm_totalContract","nm_corpVisit","nm_corpContract","nm_referralCards",
      "tg_totalVisit","tg_totalContract","tg_corpVisit","tg_corpContract","tg_referralCards",
      "topics"
    ].forEach(id => $(id).addEventListener("input", onAnyInput));

    $("btnAddRow").addEventListener("click", ()=>{
      state.reportPartners.push({ name:"", property:"", visit:0, contract:0, first:0, apply:0 });
      renderPartners();
      recalcAll();
      saveState();
    });

    $("btnExport").addEventListener("click", exportJSON);
    $("btnImport").addEventListener("click", importJSON);
    $("btnReset").addEventListener("click", resetAll);

    $("btnPrint").addEventListener("click", ()=>{
      // å°åˆ·ç”¨ãƒšãƒ¼ã‚¸ã¸ï¼ˆåˆ¥ã‚¿ãƒ–ï¼‰
      const w = window.open("./print.html", "_blank");
      if(w) w.opener = null;
    });
  }

  // ===================== Boot =====================
  initCharts();
  setUIFromState();
  renderPartners();
  recalcAll();
  attachEventsOnce();
  setSaveStatus("ä¿å­˜æ¸ˆã¿");
})();
</script>
</body>
</html>